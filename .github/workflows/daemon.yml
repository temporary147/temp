name: Daemon

on:
  workflow_dispatch:

jobs:
  run-script:
    name: Run Script
    runs-on: ubuntu-latest
    timeout-minutes: 8

    env:
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      # tuned
      HTTP_TIMEOUT_MS: "7000"
      ADAPTER_TIMEOUT_MS: "25000"
      GLOBAL_JOB_TIMEOUT_MS: "75000"
      CACHE_TTL_SECONDS: "20"
      DEBUG_API: "false"

      # tuning: chunk size for multi-row insert (tune if provider errors)
      LIBSQL_CHUNK_SIZE: "600"

      # Secrets
      Z9_A1: ${{ secrets.Z9_A1 }}
      Z9_B2: ${{ secrets.Z9_B2 }}
      Z9_C3: ${{ secrets.Z9_C3 }}
      Z9_D4: ${{ secrets.Z9_D4 }}
      Z9_E5: ${{ secrets.Z9_E5 }}
      Z9_F6: ${{ secrets.Z9_F6 }}
      Z9_G7: ${{ secrets.Z9_G7 }}
      Z9_H8: ${{ secrets.Z9_H8 }}
      Z9_I9: ${{ secrets.Z9_I9 }}
      Z9_J0: ${{ secrets.Z9_J0 }}
      Z9_K1: ${{ secrets.Z9_K1 }}
      Z9_K2: ${{ secrets.Z9_K2 }}
      # Turso / libsql URL & key (set in repo secrets)
      DBT_URL: ${{ secrets.DBT_URL }}
      DBT_KEY: ${{ secrets.DBT_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Ensure DB schema (run once)
        run: python ensure_schema.py

      - name: Run script
        run: python cfr.py



# name: Daemon

# on:
#   workflow_dispatch:

# jobs:
#   run-script:
#     name: Run Funding Normalizer
#     runs-on: ubuntu-latest
#     timeout-minutes: 5   # overall job timeout safe

#     env:
#       PYTHONUNBUFFERED: "1"
#       PIP_DISABLE_PIP_VERSION_CHECK: "1"

#       HTTP_TIMEOUT_MS: "7000"
#       ADAPTER_TIMEOUT_MS: "25000"
#       GLOBAL_JOB_TIMEOUT_MS: "75000"
#       CACHE_TTL_SECONDS: "20"
#       DEBUG_API: "false"

#       Z9_A1: ${{ secrets.Z9_A1 }}
#       Z9_B2: ${{ secrets.Z9_B2 }}
#       Z9_C3: ${{ secrets.Z9_C3 }}
#       Z9_D4: ${{ secrets.Z9_D4 }}
#       Z9_E5: ${{ secrets.Z9_E5 }}
#       Z9_F6: ${{ secrets.Z9_F6 }}
#       Z9_G7: ${{ secrets.Z9_G7 }}
#       Z9_H8: ${{ secrets.Z9_H8 }}
#       Z9_I9: ${{ secrets.Z9_I9 }}
#       Z9_J0: ${{ secrets.Z9_J0 }}
#       Z9_K1: ${{ secrets.Z9_K1 }}
#       Z9_K2: ${{ secrets.Z9_K2 }}
#       URI: ${{ secrets.URI }}
#       NAME: ${{ secrets.NAME }}
#       DBT_KEY: ${{ secrets.DBT_KEY }}
#       DBT_URL: ${{ secrets.DBT_URL }}

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up Python 3.11
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"
#           cache: "pip"

#       - name: Install dependencies
#         run: pip install -r requirements.txt

#       - name: Run script
#         run: python cfr.py   # timeout removed to allow script to complete naturally
